#!/usr/bin/env ruby
require 'led_panel'
require 'bunny'

module LEDPanel
  class Client

    def initialize
      @connection = Bunny.new
    end

    def run
      with_connection do |con|
        channel = con.create_channel

        # Create the queue here as well – ensure that it exists
        queue = channel.queue(LEDPanel::QUEUE_NAME)

        puts("Client started. Listening on queue “#{queue.name}”.")
        begin
          queue.subscribe(block: true) do |delivery_info, properties, body|
            puts(body)
          end
        rescue Interrupt
          return
        end
      end
    end

    private

      def with_connection
        @connection.start
        yield(@connection)
        @connection.close
      end

  end
end

client = LEDPanel::Client.new
client.run
